---
layout: post
title: "Monitoring Multi-Host Docker Setups with WUD via TCP and TLS"
author: krzysiek
categories: [proxmox, linux, docker]
image: "https://getwud.github.io/wud/assets/wud-arch.png"
featured: true
hidden: false
---

Managing multiple Docker hosts can become tricky, especially when trying to track which containers are outdated. 
[What's Up Docker (WUD)](https://github.com/fmartinou/whats-up-docker) solves this by checking for image updates. 

This technical guide shows how to implement WUD in a multi-host environment using two **separate** methods:

* üîå **TCP without TLS** (unsecured, only for internal networks)
* üîí **TCP with TLS** (secure, production-ready)

---

## üß∞ Requirements

Before starting, ensure you have:

* A Linux-based server to act as the **WUD Master Node**
* Remote Docker hosts to be monitored (Ubuntu/Debian recommended)
* Docker Engine ‚â• 20.x on all nodes
* Basic `openssl` tools to generate TLS certificates (optional but recommended)

Optional but useful:

* Docker Compose
* Access to port `2375` (TCP) and/or `2376` (TLS)
* Shell or SSH access to all Docker hosts

---

## üß± Step 1: Install the WUD Master Server

On your monitoring server (e.g. 192.168.69.250), deploy WUD via Docker Compose:

```yaml
version: '3.8'
services:
  whatsupdocker:
    image: ghcr.io/getwud/wud:8.0.1
    container_name: wud
    restart: always
    ports:
      - 3000:3000
    volumes:
      - ./certs:/certs:ro
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WUD_LOG_LEVEL=info
      - WUD_WATCHER_LOCAL_TYPE=docker
      - WUD_WATCHER_LOCAL_SOCKET=/var/run/docker.sock
      # Add TCP or TLS watchers here as needed
```

Start the service:

```bash
docker compose up -d
```

Visit the WUD dashboard at: `http://<WUD_IP>:3000`

This setup will monitor containers on the **local host** as well.

---

## üñß Method 1: Expose Docker over TCP (No TLS)

Use this for trusted internal networks only.

### üõ† Modify Docker Daemon on Remote Node

On the remote host (e.g. 192.168.69.249):

Edit `/etc/docker/daemon.json`:

```json
{
  "hosts": ["unix:///var/run/docker.sock", "tcp://0.0.0.0:2375"]
}
```

Restart Docker:

```bash
sudo systemctl restart docker
```

### üì° Add Watcher to WUD Master

Append to the master's `environment:` section in `docker-compose.yml`:

```yaml
      - WUD_WATCHER_NODE_TYPE=docker
      - WUD_WATCHER_NODE_SOCKET=tcp://192.168.69.249:2375
```

Apply the changes:

```bash
docker compose up -d
```

---

## üîê Method 2: Secure Docker TCP with TLS

This is the **recommended** method for production or exposed environments.

### üîë Generate TLS Certificates

On the remote Docker host:

```bash
mkdir ~/docker-certs && cd ~/docker-certs

# Generate CA
openssl genrsa -aes256 -out ca-key.pem 4096
openssl req -new -x509 -days 365 -key ca-key.pem -sha256 -out ca.pem

# Server key/cert
openssl genrsa -out server-key.pem 4096
openssl req -subj "/CN=$(hostname)" -new -key server-key.pem -out server.csr
openssl x509 -req -days 365 -sha256 -in server.csr -CA ca.pem -CAkey ca-key.pem \
  -CAcreateserial -out server-cert.pem
```

Set permissions:

```bash
chmod 400 ca-key.pem server-key.pem
chmod 444 ca.pem server-cert.pem
```

### üîß Docker Daemon TLS Config

Create or modify `/etc/docker/daemon.json`:

```json
{
  "tls": true,
  "tlsverify": true,
  "tlscacert": "/etc/docker/certs/ca.pem",
  "tlscert": "/etc/docker/certs/server-cert.pem",
  "tlskey": "/etc/docker/certs/server-key.pem",
  "hosts": ["unix:///var/run/docker.sock", "tcp://0.0.0.0:2376"]
}
```

Move certificates:

```bash
sudo mkdir -p /etc/docker/certs
sudo cp *.pem /etc/docker/certs
sudo systemctl restart docker
```

### üß© Configure WUD Master for TLS

On the WUD master, prepare client certs (`ca.pem`, `client-cert.pem`, `client-key.pem`) and store them in `./certs/`.

Then extend the environment block:

```yaml
      - WUD_WATCHER_NODE_TYPE=docker
      - WUD_WATCHER_NODE_SOCKET=tcp://192.168.69.249:2376
      - WUD_WATCHER_NODE_TLS_CA=/certs/ca.pem
      - WUD_WATCHER_NODE_TLS_CERT=/certs/client-cert.pem
      - WUD_WATCHER_NODE_TLS_KEY=/certs/client-key.pem
```

Restart the container:

```bash
docker compose up -d
```

---

## ‚úÖ Verifying Setup

* Open `http://<WUD_MASTER>:3000`
* You should see containers from the local host and remote host (NODE)
* Check logs via `docker logs wud` for watcher registration

---

## üõ° Security Considerations

| Feature         | TCP (No TLS) | TCP with TLS            |
| --------------- | ------------ | ----------------------- |
| Encrypted       | ‚ùå            | ‚úÖ                       |
| Authentication  | ‚ùå            | ‚úÖ (certs required)      |
| Safe for public | ‚ùå NEVER      | ‚úÖ If firewall protected |

* Always use TLS in untrusted or internet-facing environments
* Use firewalls to restrict TCP ports (2375/2376)
* Rotate TLS certificates regularly

---

## üß™ Optional: Add Prometheus Metrics

Expose WUD metrics at `/metrics`:

```yaml
      - WUD_PROMETHEUS_ENABLED=true
```

---

## üßº Cleanup

To stop WUD:

```bash
docker compose down
```

To remove Docker TCP endpoint:

```bash
sudo nano /etc/docker/daemon.json
# Remove tcp://0.0.0.0:2375 or :2376
sudo systemctl restart docker
```

---

## üèÅ Conclusion

WUD is a powerful solution to monitor outdated containers across multiple Docker hosts. Whether you're securing your setup with TLS or quickly prototyping with TCP, you now have a reliable multi-host monitoring system.

---

üìö **Resources:**

* [Official WUD Docs](https://getwud.github.io/wud/#/configuration/watchers/)
* [Docker Engine TLS Setup](https://docs.docker.com/engine/security/protect-access/)
* [OpenSSL Cheat Sheet](https://www.patreon.com/file?h=109937722&m=339848105)

Happy monitoring! üö¢
